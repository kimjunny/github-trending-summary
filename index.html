// Node.js ì„œë²„ ì˜ˆì œ (Express + Puppeteer)
const express = require('express');
const puppeteer = require('puppeteer');
const app = express();

// CORS ì„¤ì •
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Headers', 'Content-Type');
    next();
});

// GitHub íŠ¸ë Œë”© ìŠ¤í¬ë˜í•‘ í•¨ìˆ˜
async function scrapeTrending() {
    const browser = await puppeteer.launch();
    const page = await browser.newPage();
    
    try {
        await page.goto('https://github.com/trending');
        
        // íŠ¸ë Œë”© ë¦¬í¬ì§€í† ë¦¬ ì •ë³´ ì¶”ì¶œ
        const repos = await page.evaluate(() => {
            const repoElements = document.querySelectorAll('article.Box-row');
            
            return Array.from(repoElements).map(repo => {
                const nameElement = repo.querySelector('h2 a');
                const descElement = repo.querySelector('p');
                const langElement = repo.querySelector('[itemprop="programmingLanguage"]');
                const starsElement = repo.querySelector('svg.octicon-star').parentElement;
                
                return {
                    name: nameElement ? nameElement.textContent.trim() : '',
                    url: nameElement ? 'https://github.com' + nameElement.getAttribute('href') : '',
                    description: descElement ? descElement.textContent.trim() : '',
                    language: langElement ? langElement.textContent.trim() : '',
                    stars: starsElement ? starsElement.textContent.trim() : ''
                };
            });
        });
        
        await browser.close();
        return repos;
        
    } catch (error) {
        await browser.close();
        throw error;
    }
}

// API ì—”ë“œí¬ì¸íŠ¸
app.get('/api/trending', async (req, res) => {
    try {
        const repos = await scrapeTrending();
        res.json({ success: true, data: repos });
    } catch (error) {
        res.status(500).json({ success: false, error: error.message });
    }
});

// ì •ì  HTML íŒŒì¼ ì œê³µ
app.use(express.static('public'));

// ì„œë²„ ì‹œì‘
const PORT = 3000;
app.listen(PORT, () => {
    console.log(`ì„œë²„ê°€ http://localhost:${PORT} ì—ì„œ ì‹¤í–‰ì¤‘ì…ë‹ˆë‹¤`);
});

// ===== í´ë¼ì´ì–¸íŠ¸ ì¸¡ JavaScript (HTMLì— ì¶”ê°€) =====
// ì´ ì½”ë“œë¥¼ HTML íŒŒì¼ì˜ <script> íƒœê·¸ ì•ˆì— ì¶”ê°€í•˜ì„¸ìš”

async function fetchTrendingRepos() {
    try {
        const response = await fetch('http://localhost:3000/api/trending');
        const data = await response.json();
        
        if (data.success) {
            updateRepoCards(data.data);
        }
    } catch (error) {
        console.error('íŠ¸ë Œë”© ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', error);
    }
}

function updateRepoCards(repos) {
    // AI ê´€ë ¨ í‚¤ì›Œë“œ
    const aiKeywords = ['ai', 'ml', 'machine learning', 'deep learning', 'neural', 'gpt', 'llm'];
    
    // ê°œë°œ ë„êµ¬ ê´€ë ¨ í‚¤ì›Œë“œ
    const devToolKeywords = ['editor', 'ide', 'terminal', 'cli', 'tool', 'framework'];
    
    // ë¦¬í¬ì§€í† ë¦¬ ë¶„ë¥˜
    const aiRepos = repos.filter(repo => 
        aiKeywords.some(keyword => 
            repo.description.toLowerCase().includes(keyword) ||
            repo.name.toLowerCase().includes(keyword)
        )
    );
    
    const devRepos = repos.filter(repo =>
        devToolKeywords.some(keyword =>
            repo.description.toLowerCase().includes(keyword) ||
            repo.name.toLowerCase().includes(keyword)
        )
    );
    
    // DOM ì—…ë°ì´íŠ¸
    updateCategoryRepos('ai-repos', aiRepos);
    updateCategoryRepos('dev-repos', devRepos);
}

function updateCategoryRepos(containerId, repos) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    repos.forEach(repo => {
        const card = createRepoCard(repo);
        container.appendChild(card);
    });
}

function createRepoCard(repo) {
    const card = document.createElement('div');
    card.className = 'repo-card';
    
    card.innerHTML = `
        <div class="repo-header">
            <div class="repo-icon">${getRepoIcon(repo)}</div>
            <div class="repo-name">${repo.name}</div>
        </div>
        <div class="repo-description">${repo.description}</div>
        <div class="repo-tags">
            ${repo.language ? `<span class="tag">${repo.language}</span>` : ''}
            <span class="tag">â­ ${repo.stars}</span>
        </div>
        <a href="${repo.url}" class="repo-link" target="_blank">
            ë¦¬í¬ì§€í† ë¦¬ ë°©ë¬¸
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8.22 2.97a.75.75 0 0 1 1.06 0l4.25 4.25a.75.75 0 0 1 0 1.06l-4.25 4.25a.75.75 0 0 1-1.06-1.06L11.19 8.5H3.75a.75.75 0 0 1 0-1.5h7.44L8.22 4.03a.75.75 0 0 1 0-1.06Z"/>
            </svg>
        </a>
    `;
    
    return card;
}

function getRepoIcon(repo) {
    const desc = repo.description.toLowerCase();
    if (desc.includes('ai') || desc.includes('ml')) return 'ğŸ¤–';
    if (desc.includes('tool') || desc.includes('editor')) return 'ğŸ› ï¸';
    if (desc.includes('learn') || desc.includes('tutorial')) return 'ğŸ“š';
    return 'ğŸ“¦';
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
document.addEventListener('DOMContentLoaded', fetchTrendingRepos);

// 30ë¶„ë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
setInterval(fetchTrendingRepos, 30 * 60 * 1000);
